@model CV_siten.Data.Models.Person

<div class="profile-page-wrapper">
	<aside class="profile-sidebar">
		<div class="sidebar-card">
			@* 1. Profilbild *@
			<div class="pic-placeholder">
				@if (!string.IsNullOrEmpty(Model.ImageUrl))
				{
					<img src="~/images/@Model.ImageUrl" alt="Profilbild" style="width:100%; height:100%; object-fit:cover;" />
				}
				else
				{
					<span style="color: #ecf0f1;">Profilbild</span>
				}
			</div>

			<div class="profile-info-text">
				@* 2. Namn och Roll *@
				<h2 class="profile-name">@Model.FirstName @Model.LastName</h2>
				<p class="profile-title">@Model.JobTitle</p>

				@* 3. Kontaktuppgifter *@
				<div class="profile-contact-details">
					<p class="contact-item">
						<i class="fas fa-phone"></i> <strong>Tel:</strong> @(string.IsNullOrEmpty(Model.PhoneNumber) ? "Ej angivet" : Model.PhoneNumber)
					</p>
					<p class="contact-item">
						<i class="fas fa-envelope"></i> <strong>Email:</strong> @(Model.IdentityUser?.Email ?? "test@test.se")
					</p>
					<p class="contact-item">
						<i class="fas fa-map-marker-alt"></i> <strong>Adress:</strong><br />
						@Model.Address<br />
						@Model.PostalCode @Model.City
					</p>
				</div>

				@* 4. Bio/Beskrivning *@
				<div class="profile-bio">
					<p>@(string.IsNullOrEmpty(Model.Description) ? "Ingen beskrivning tillgänglig." : Model.Description)</p>
				</div>
				@if (ViewBag.IsOwner != true)
				{
					<button type="button"
							class="btn-action btn-primary"
							style="margin-top: 15px; width: 100%;"
							data-bs-toggle="modal"
							data-bs-target="#sendMessageModal"
							data-receiver-id="@Model.Id"
							data-receiver-name="@($"{Model.FirstName} {Model.LastName}")">
						Skicka meddelande
					</button>
				}


				@* Besöksstatistik *@
				@if (ViewBag.IsOwner == true)
				{
					<div class="profile-stats" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; font-size: 0.9em; color: #7f8c8d;">
						<p><i class="fas fa-eye"></i> Antal visningar: <strong>@Model.ViewCount</strong></p>
					</div>
				}
			</div>

			@* 5. Knappar i Sidebar *@
			<div class="sidebar-actions-container">
				@if (ViewBag.IsOwner == true)
				{
					@* Bekräftelsemeddelande vid statusändring *@
					@if (TempData["StatusMessage"] != null)
					{
						<div class="alert alert-info py-1 text-center" style="font-size: 0.75rem; margin-bottom: 10px; border-radius: 8px;">
							@TempData["StatusMessage"]
						</div>
					}

					@* --- HUVUDHANDLINGAR (Blå & Turkos) --- *@
					@if (string.IsNullOrEmpty(Model.CvUrl))
					{
						<form id="cvUploadForm" asp-controller="Person" asp-action="UploadCv" method="post" enctype="multipart/form-data" style="display:none;">
							<input type="hidden" name="personId" value="@Model.Id" />
							<input type="file" id="cvFileInput" name="cvFile" accept=".pdf" onchange="document.getElementById('cvUploadForm').submit();" />
						</form>
						<button type="button" class="btn-action btn-primary" onclick="document.getElementById('cvFileInput').click();">Ladda upp mitt CV</button>
					}
					else
					{
						<div class="cv-button-row" style="display: flex; gap: 5px; margin-bottom: 5px;">
							<a href="@Model.CvUrl" target="_blank" class="btn-action btn-primary" style="flex: 3; text-align:center;">Visa CV</a>
							<form asp-controller="Person" asp-action="DeleteCv" method="post" onsubmit="return confirm('Vill du ta bort ditt CV?');" style="flex: 1;">
								<input type="hidden" name="personId" value="@Model.Id" />
								<button type="submit" class="btn-action btn-danger" style="width: 100%;"><i class="fas fa-trash"></i></button>
							</form>
						</div>
					}

					<a asp-controller="Person" asp-action="Edit" class="btn-action btn-secondary-outline">Redigera profil</a>

					<a asp-controller="Person" asp-action="ExportToXml" class="btn-action" style="background-color: #17a2b8; color: white; border: none; margin-top: 5px; text-decoration: none; display: flex; align-items: center; justify-content: center;">
						<i class="fas fa-file-export" style="margin-right: 8px;"></i> Exportera CV (XML)
					</a>

					@* --- KONTOINSTÄLLNINGAR (Längst ner) --- *@
					<div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">

						@* Sekretess-switch *@
						<div class="privacy-status" style="margin-bottom: 10px; padding: 10px; background-color: @(Model.IsPrivate ? "#2c3e50" : "#fff3cd"); border-radius: 8px; text-align: center; border: 1px solid @(Model.IsPrivate ? "#34495e" : "#ffeeba");">
							<p style="color: @(Model.IsPrivate ? "#ecf0f1" : "#856404"); font-size: 0.8em; margin-bottom: 5px; font-weight: bold;">
								STATUS: @(Model.IsPrivate ? "PRIVAT" : "OFFENTLIG")
							</p>
							<form asp-controller="Person" asp-action="TogglePrivacy" method="post">
								<input type="hidden" name="id" value="@Model.Id" />
								<button type="submit" class="btn btn-sm @(Model.IsPrivate ? "btn-success" : "btn-warning")" style="width: 100%; font-size: 0.8em;">
									<i class="fas @(Model.IsPrivate ? "fa-toggle-off" : "fa-toggle-on")"></i> Ändra status
								</button>
							</form>
						</div>

						@* --- DYNAMISK INAKTIVERA/AKTIVERA KNAPP --- *@
						@if (Model.IsActive)
						{
							<form asp-controller="Person" asp-action="Inactivate" method="post">
								<input type="hidden" name="id" value="@Model.Id" />
								<button type="submit" class="btn-action btn-danger-outline" style="font-size: 0.8em; opacity: 0.8; width: 100%;">
									<i class="fas fa-user-slash"></i> Inaktivera profil
								</button>
							</form>
						}
						else
						{
							<form asp-controller="Person" asp-action="Activate" method="post">
								<input type="hidden" name="id" value="@Model.Id" />
								<button type="submit" class="btn-action" style="font-size: 0.8em; background-color: #28a745; color: white; border: none; width: 100%;">
									<i class="fas fa-user-check"></i> Aktivera profil
								</button>
							</form>
						}
					</div>
				}
			</div>
		</div>
	</aside>

	<section class="profile-main-content">
		@* Kompetenser *@
		<div class="cv-section" id="section-Skills">
			<form asp-action="UpdateProfileField" method="post">
				<input type="hidden" name="id" value="@Model.Id" />
				<input type="hidden" name="fieldName" value="Skills" />
				<div class="cv-header-row">
					<h3 class="section-title">Kompetenser</h3>
					@if (ViewBag.IsOwner == true)
					{
						<button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Skills')">Redigera</button>
						<button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
					}
				</div>
				<p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Skills) ? "Inga kompetenser angivna." : Model.Skills)</p>
				<textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Skills</textarea>
			</form>
		</div>

		@* Utbildningar *@
		<div class="cv-section" id="section-Education">
			<form asp-action="UpdateProfileField" method="post">
				<input type="hidden" name="id" value="@Model.Id" />
				<input type="hidden" name="fieldName" value="Education" />
				<div class="cv-header-row">
					<h3 class="section-title">Utbildningar</h3>
					@if (ViewBag.IsOwner == true)
					{
						<button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Education')">Redigera</button>
						<button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
					}
				</div>
				<p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Education) ? "Ingen utbildningsinformation angiven." : Model.Education)</p>
				<textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Education</textarea>
			</form>
		</div>

		@* Erfarenheter *@
		<div class="cv-section" id="section-Experience">
			<form asp-action="UpdateProfileField" method="post">
				<input type="hidden" name="id" value="@Model.Id" />
				<input type="hidden" name="fieldName" value="Experience" />
				<div class="cv-header-row">
					<h3 class="section-title">Tidigare erfarenheter</h3>
					@if (ViewBag.IsOwner == true)
					{
						<button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Experience')">Redigera</button>
						<button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
					}
				</div>
				<p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Experience) ? "Ingen tidigare erfarenhet angiven." : Model.Experience)</p>
				<textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Experience</textarea>
			</form>
		</div>

		@* Projektblock *@
		<div class="projects-block" id="projects-section">
			<div class="cv-header-row">
				<h3 class="section-title">Mina Projekt</h3>
			</div>

			@* --- PROJEKTBLOCK VERKTYGSFÄLT (Allt på en rad) --- *@
			<form asp-action="Profile" asp-fragment="projects-section" method="get"
				  class="content-toolbar"
				  style="display: flex; align-items: center; justify-content: space-between; flex-wrap: nowrap; gap: 15px; margin-bottom: 20px;">

				<input type="hidden" name="id" value="@Model.Id" />

				@* GRUPP 1: Sök och Sortering *@
				<div style="display: flex; align-items: center; gap: 10px; flex-grow: 1;">
					@* Sökfält *@
					<input type="text" name="searchString" value="@ViewBag.CurrentSearch"
						   placeholder="Sök projekt eller roll..." class="form-control-custom"
						   style="margin-bottom: 0; flex-grow: 1; max-width: 300px;">

					@* Sortering *@
					<select name="sortBy" class="form-select-custom" onchange="this.form.submit()"
							style="margin-bottom: 0; width: auto; min-width: 160px;">
						<option value="">Sortera efter...</option>
						<optgroup label="Namn">
							<option value="name_asc" selected="@(ViewBag.CurrentSort == "name_asc")">Projektnamn: A-Ö</option>
							<option value="name_desc" selected="@(ViewBag.CurrentSort == "name_desc")">Projektnamn: Ö-A</option>
						</optgroup>
						<optgroup label="Status (Visa först)">
							<option value="status_planerat" selected="@(ViewBag.CurrentSort == "status_planerat")">Status: Planerat</option>
							<option value="status_aktivt" selected="@(ViewBag.CurrentSort == "status_aktivt")">Status: Aktivt</option>
							<option value="status_pausat" selected="@(ViewBag.CurrentSort == "status_pausat")">Status: Pausat</option>
							<option value="status_avslutat" selected="@(ViewBag.CurrentSort == "status_avslutat")">Status: Avslutat</option>
						</optgroup>
						<optgroup label="Deltagare">
							<option value="members_asc" selected="@(ViewBag.CurrentSort == "members_asc")">Antal deltagare: Stigande</option>
							<option value="members_desc" selected="@(ViewBag.CurrentSort == "members_desc")">Antal deltagare: Fallande</option>
						</optgroup>
						<option value="tid" selected="@(ViewBag.CurrentSort == "tid")">Tid (Nyast först)</option>
					</select>

					@* Sök-knapp *@
					<button type="submit" class="btn-action btn-primary btn-small" style="width: 80px; margin: 0;">Sök</button>

					@* Rensa-knapp *@
					@if (!string.IsNullOrEmpty(ViewBag.CurrentSearch) || !string.IsNullOrEmpty(ViewBag.CurrentSort))
					{
						<a asp-action="Profile" asp-route-id="@Model.Id" asp-fragment="projects-section"
						   class="btn-action btn-small"
						   style="width: 80px; background-color: #e74c3c; color: white; text-decoration: none; text-align: center; border: none; margin: 0; display: flex; align-items: center; justify-content: center;">
							Rensa
						</a>
					}
				</div>

				@* GRUPP 2: Hantera projekt (Visas till höger) *@
				@if (ViewBag.IsOwner == true)
				{
					<div style="display: flex; gap: 10px; flex-shrink: 0;">
						<a asp-controller="Project" asp-action="AddProject" class="btn-action btn-outline btn-small" style="margin: 0; white-space: nowrap;">Lägg till projekt</a>
						<a asp-controller="Project" asp-action="JoinProject" class="btn-action btn-outline btn-small" style="margin: 0; white-space: nowrap;">Gå med i projekt</a>
					</div>
				}
			</form>

			@* --- PROJEKTGRID --- *@
			@if (Model.PersonProjects != null && Model.PersonProjects.Any())
			{
				<div class="projects-grid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
					@foreach (var pp in Model.PersonProjects)
					{
						bool isProjectOwner = pp.Project.OwnerId == Model.Id;

						<a asp-controller="Project" asp-action="ProjectDetails" asp-route-id="@pp.Project.Id"
						   class="project-card"
						   style="position: relative; text-decoration: none; color: inherit; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; min-height: 380px; border: 1px solid #eee;">

							@if (isProjectOwner)
							{
								<div style="position: absolute; top: 0; right: 0; background: #3498db; color: white; font-size: 0.7rem; font-weight: bold; padding: 5px 12px; border-radius: 0 12px 0 10px; letter-spacing: 0.5px; z-index: 5; box-shadow: -2px 2px 5px rgba(0,0,0,0.1);">
									ÄGARE
								</div>
							}

							@* 1. PROJEKTBILD *@
							<div class="project-card-image" style="width: 100%; height: 160px; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; border-bottom: 1px solid #f0f0f0;">
								@if (!string.IsNullOrEmpty(pp.Project.ImageUrl))
								{
									<img src="@Url.Content("~/images/projects/" + pp.Project.ImageUrl)" alt="@pp.Project.ProjectName" style="width: 100%; height: 100%; object-fit: cover;" />
								}
								else
								{
									<i class="fas fa-project-diagram" style="font-size: 3rem; color: #cbd5e0;"></i>
								}
							</div>

							@* 2. INNEHÅLL *@
							<div style="padding: 20px; flex-grow: 1; display: flex; flex-direction: column;">

								@* RUBRIK OCH ROLL (I FOKUS) *@
								<div style="margin-bottom: 15px; border-bottom: 1px solid #f0f2f5; padding-bottom: 10px;">
									<span style="font-weight: 800; display: block; color: #002d5a; font-size: 1.2rem; line-height: 1.2; margin-bottom: 4px;">
										@pp.Project.ProjectName
									</span>
									<span style="font-size: 0.9rem; color: #3498db; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
										<i class="fas fa-user-tag" style="font-size: 0.8rem; margin-right: 5px;"></i>
										@(string.IsNullOrEmpty(pp.Role) ? "Deltagare" : pp.Role)
									</span>
								</div>

								@* DETALJER (KOMPAKT INFO) *@
								<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.8rem; color: #4a5568;">
									<div title="Typ">
										<i class="fas fa-layer-group" style="width: 15px; color: #718096;"></i>
										<strong>Typ:</strong> @(pp.Project.Type ?? "Ej angiven")
									</div>
									<div title="Status">
										<i class="fas fa-circle" style="width: 15px; color: @(pp.Project.Status == "Aktivt" ? "#48bb78" : "#a0aec0"); font-size: 0.6rem; vertical-align: middle;"></i>
										<strong>Status:</strong> @(pp.Project.Status ?? "Aktivt")
									</div>
									<div title="Startdatum">
										<i class="fas fa-calendar-alt" style="width: 15px; color: #718096;"></i>
										<strong>Start:</strong> @pp.Project.StartDate.ToString("yyyy-MM-dd")
									</div>
									<div title="Slutdatum">
										<i class="fas fa-calendar-check" style="width: 15px; color: #718096;"></i>
										<strong>Slut:</strong> @pp.Project.EndDate?.ToString("yyyy-MM-dd")
									</div>
								</div>

								@* DELTAGAR-COUNT *@
								<div style="margin-top: auto; padding-top: 15px; display: flex; align-items: center; border-top: 1px solid #f0f2f5;">
									<div style="display: flex; align-items: center; background: #ebf5ff; padding: 4px 10px; border-radius: 20px; color: #2b6cb0; font-weight: 600; font-size: 0.75rem;">
										<i class="fas fa-users" style="margin-right: 6px;"></i>
										@* Här räknas nu alla som är kopplade till projektet *@
										@(pp.Project.PersonProjects?.Count ?? 0) deltagare
									</div>
								</div>
							</div>
						</a>
					}
				</div>
			}
		</div>

		@* --- HITTA LIKNANDE PERSONER (VG-Krav 5) --- *@
		@if (ViewBag.SimilarPerson != null)
		{
			<div class="cv-section" style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px;">
				<div class="cv-header-row">
					<h3 class="section-title"><i class="fas fa-user-friends"></i> Hitta liknande personer</h3>
				</div>
				<p class="text-muted">Baserat på profilens kompetenser föreslår vi även följande profil:</p>

				<div class="similar-profile-card" style="display: flex; align-items: center; background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #ddd; max-width: 450px;">
					<div style="width: 70px; height: 70px; border-radius: 50%; overflow: hidden; margin-right: 15px; border: 2px solid #002d5a;">
						@if (!string.IsNullOrEmpty(ViewBag.SimilarPerson.ImageUrl))
						{
							<img src="~/images/ProfilePicture/@ViewBag.SimilarPerson.ImageUrl" alt="Profilbild" style="width:100%; height:100%; object-fit:cover;" />
						}
						else
						{
							<div style="width:100%; height:100%; background:#ccc; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-user"></i></div>
						}
					</div>
					<div style="flex-grow: 1;">
						<h5 style="margin: 0; color: #002d5a; font-weight: bold;">@ViewBag.SimilarPerson.FirstName @ViewBag.SimilarPerson.LastName</h5>
						<p style="margin: 0 0 8px 0; font-size: 0.85em; color: #666;">@ViewBag.SimilarPerson.JobTitle</p>

						<div class="match-badge mb-2" style="background: #e7f3ff; color: #0056b3; padding: 3px 8px; border-radius: 15px; font-size: 0.75rem; font-weight: 700; display: inline-block; border: 1px solid #b3d7ff;">
							<i class="fas fa-bullseye"></i> @ViewBag.MatchScore% Matchning
						</div>
						<br />
						<a asp-action="Profile" asp-route-id="@ViewBag.SimilarPerson.Id" class="btn btn-sm btn-primary" style="background-color: #002d5a; border: none;">Visa profil</a>
					</div>
				</div>
			</div>
		}
	</section>
	<partial name="SendMessageModal" />
</div>
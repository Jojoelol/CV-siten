@model CV_siten.Data.Models.Person

<div class="profile-page-wrapper">
    <aside class="profile-sidebar">
        <div class="sidebar-card">
            @* 1. Profilbild *@
            <div class="pic-placeholder">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="~/images/@Model.ImageUrl" alt="Profilbild" style="width:100%; height:100%; object-fit:cover;" />
                }
                else
                {
                    <span style="color: #ecf0f1;">Profilbild</span>
                }
            </div>

            <div class="profile-info-text">
                @* 2. Namn och Roll *@
                <h2 class="profile-name">@Model.FirstName @Model.LastName</h2>
                <p class="profile-title">@Model.JobTitle</p>

                @* 3. Kontaktuppgifter *@
                <div class="profile-contact-details">
                    <p class="contact-item">
                        <i class="fas fa-phone"></i> <strong>Tel:</strong> @(string.IsNullOrEmpty(Model.PhoneNumber) ? "Ej angivet" : Model.PhoneNumber)
                    </p>
                    <p class="contact-item">
                        <i class="fas fa-envelope"></i> <strong>Email:</strong> @(Model.IdentityUser?.Email ?? "test@test.se")
                    </p>
                    <p class="contact-item">
                        <i class="fas fa-map-marker-alt"></i> <strong>Adress:</strong><br />
                        @Model.Address<br />
                        @Model.PostalCode @Model.City
                    </p>
                </div>

                @* 4. Bio/Beskrivning *@
                <div class="profile-bio">
                    <p>@(string.IsNullOrEmpty(Model.Description) ? "Ingen beskrivning tillgänglig." : Model.Description)</p>
                </div>

                @* Besöksstatistik *@
                @if (ViewBag.IsOwner == true)
                {
                    <div class="profile-stats" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; font-size: 0.9em; color: #7f8c8d;">
                        <p><i class="fas fa-eye"></i> Antal visningar: <strong>@Model.ViewCount</strong></p>
                    </div>
                }
            </div>

            @* 5. Knappar i Sidebar *@
            <div class="sidebar-actions-container">
                @if (ViewBag.IsOwner == true)
                {
                    @* --- SEKRETESSINSTÄLLNING (Privat/Offentlig) --- *@
                    <div class="privacy-status" style="margin-bottom: 15px; padding: 12px; background-color: @(Model.IsPrivate ? "#fff3cd" : "#d1e7dd"); border-radius: 8px; font-size: 0.85em; text-align: center; border: 1px solid @(Model.IsPrivate ? "#ffeeba" : "#badbcc");">
                        @if (Model.IsPrivate)
                        {
                            <p style="color: #856404; margin-bottom: 8px; font-weight: bold;"><i class="fas fa-lock"></i> Profilen är Privat</p>
                            <form asp-controller="Person" asp-action="TogglePrivacy" method="post">
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-sm btn-success" style="width: 100%;">Gör offentlig</button>
                            </form>
                        }
                        else
                        {
                            <p style="color: #0f5132; margin-bottom: 8px; font-weight: bold;"><i class="fas fa-globe"></i> Profilen är Offentlig</p>
                            <form asp-controller="Person" asp-action="TogglePrivacy" method="post">
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn btn-sm btn-warning" style="width: 100%;">Gör privat</button>
                            </form>
                        }
                    </div>

                    @* CV-Hantering *@
                    @if (string.IsNullOrEmpty(Model.CvUrl))
                    {
                        <form id="cvUploadForm" asp-controller="Person" asp-action="UploadCv" method="post" enctype="multipart/form-data" style="display:none;">
                            <input type="hidden" name="personId" value="@Model.Id" />
                            <input type="file" id="cvFileInput" name="cvFile" accept=".pdf" onchange="document.getElementById('cvUploadForm').submit();" />
                        </form>
                        <button type="button" class="btn-action btn-primary" onclick="document.getElementById('cvFileInput').click();">Ladda upp mitt CV</button>
                    }
                    else
                    {
                        <div class="cv-button-row" style="display: flex; gap: 5px; margin-bottom: 5px;">
                            <a href="@Model.CvUrl" target="_blank" class="btn-action btn-primary" style="flex: 3;">Visa CV</a>
                            <form asp-controller="Person" asp-action="DeleteCv" method="post" onsubmit="return confirm('Vill du ta bort ditt CV?');" style="flex: 1;">
                                <input type="hidden" name="personId" value="@Model.Id" />
                                <button type="submit" class="btn-action btn-danger" style="width: 100%;"><i class="fas fa-trash"></i></button>
                            </form>
                        </div>
                    }

                    <a asp-controller="Person" asp-action="Edit" class="btn-action btn-secondary-outline">Redigera profil</a>

                    <a asp-controller="Person" asp-action="ExportToXml" class="btn-action" style="background-color: #17a2b8; color: white; border: none; margin-top: 5px; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-file-export" style="margin-right: 8px;"></i> Exportera CV (XML)
                    </a>

                    @if (Model.IsActive)
                    {
                        <form asp-controller="Person" asp-action="Inactivate" method="post" style="margin-top:10px;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn-action btn-danger-outline">Inaktivera konto</button>
                        </form>
                    }
                    else
                    {
                        <form asp-controller="Person" asp-action="Activate" method="post" style="margin-top:10px;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn-action btn-success-outline">Återaktivera konto</button>
                        </form>
                    }
                }
            </div>
        </div>
    </aside>

    <section class="profile-main-content">
        @* Kompetenser *@
        <div class="cv-section" id="section-Skills">
            <form asp-action="UpdateProfileField" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="fieldName" value="Skills" />
                <div class="cv-header-row">
                    <h3 class="section-title">Kompetenser</h3>
                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Skills')">Redigera</button>
                        <button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
                    }
                </div>
                <p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Skills) ? "Inga kompetenser angivna." : Model.Skills)</p>
                <textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Skills</textarea>
            </form>
        </div>

        @* Utbildningar *@
        <div class="cv-section" id="section-Education">
            <form asp-action="UpdateProfileField" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="fieldName" value="Education" />
                <div class="cv-header-row">
                    <h3 class="section-title">Utbildningar</h3>
                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Education')">Redigera</button>
                        <button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
                    }
                </div>
                <p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Education) ? "Ingen utbildningsinformation angiven." : Model.Education)</p>
                <textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Education</textarea>
            </form>
        </div>

        @* Erfarenheter *@
        <div class="cv-section" id="section-Experience">
            <form asp-action="UpdateProfileField" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="fieldName" value="Experience" />
                <div class="cv-header-row">
                    <h3 class="section-title">Tidigare erfarenheter</h3>
                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Experience')">Redigera</button>
                        <button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
                    }
                </div>
                <p class="cv-text display-mode">@(string.IsNullOrEmpty(Model.Experience) ? "Ingen tidigare erfarenhet angiven." : Model.Experience)</p>
                <textarea name="fieldValue" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:100px;">@Model.Experience</textarea>
            </form>
        </div>

        @* Projektblock *@
        <div class="projects-block" id="projects-section">
            <div class="cv-header-row">
                <h3 class="section-title">Mina Projekt</h3>
            </div>

            <form asp-action="Profile" asp-fragment="projects-section" method="get" class="content-toolbar">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="toolbar-inputs">
                    <input type="text" name="searchString" value="@ViewBag.CurrentSearch" placeholder="Sök projekt..." class="form-control-custom">
                    <select name="sortBy" class="form-select-custom" onchange="this.form.submit()">
                        <option value="">Sortera efter...</option>
                        <option value="status">Status</option>
                        <option value="tid">Tid</option>
                    </select>
                    <button type="submit" class="btn-action btn-primary btn-small">Sök</button>
                </div>

                @if (ViewBag.IsOwner == true)
                {
                    <div class="right-buttons">
                        <a asp-controller="Project" asp-action="AddProject" class="btn-action btn-outline btn-small">Lägg till projekt</a>
                        <a asp-controller="Project" asp-action="JoinProject" class="btn-action btn-outline btn-small">Gå med i projekt</a>
                    </div>
                }
            </form>

            @if (Model.PersonProjects != null && Model.PersonProjects.Any())
            {
                <div class="projects-grid" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    @foreach (var pp in Model.PersonProjects)
                    {
                        @* Kollar om profilens ägare också äger projektet *@
                        bool isActuallyOwner = pp.Project.OwnerId == Model.Id;

                        <a asp-controller="Project" asp-action="ProjectDetails" asp-route-id="@pp.Project.Id"
                           class="project-card"
                           style="text-decoration: none; color: inherit; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s;">

                            <div class="project-card-image" style="width: 100%; height: 120px; background-color: #3498db; display: flex; justify-content: center; align-items: center;">
                                @if (!string.IsNullOrEmpty(pp.Project.ImageUrl))
                                {
                                    <img src="@Url.Content("~/images/projects/" + pp.Project.ImageUrl)" alt="@pp.Project.ProjectName" style="width: 100%; height: 100%; object-fit: cover;" />
                                }
                                else
                                {
                                    <i class="fas fa-project-diagram" style="font-size: 2rem; color: white;"></i>
                                }
                            </div>

                            <div style="padding: 10px; text-align: center;">
                                <span style="font-weight: bold; display: block; color: #002d5a; font-size: 0.9rem;">@pp.Project.ProjectName</span>
                                <span style="font-size: 0.75rem; color: @(isActuallyOwner ? "#3498db" : "#7f8c8d"); font-weight: @(isActuallyOwner ? "bold" : "normal");">
                                    @(isActuallyOwner ? "Projektägare" : (pp.Role ?? "Deltagare"))
                                </span>
                            </div>
                        </a>
                    }
                </div>
            }
        </div>
    </section>
</div>
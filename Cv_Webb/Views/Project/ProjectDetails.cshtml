@model CV_siten.Data.Models.Project

<div class="profile-page-wrapper">
    @* --- SIDEBAR: PROJEKT-INFO --- *@
    <aside class="profile-sidebar">
        <div class="sidebar-card">
            @* 1. PROJEKTBILD *@
            <div class="project-image-placeholder" style="width: 100%; height: 180px; background-color: #3498db; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; overflow: hidden;">
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="~/images/projects/@Model.ImageUrl" alt="@Model.ProjectName" style="width: 100%; height: 100%; object-fit: cover;" />
                }
                else
                {
                    <i class="fas fa-project-diagram" style="font-size: 3.5rem; color: white;"></i>
                }
            </div>

            @* 2. INFO-TEXT *@
            <div class="profile-info-text">
                <h2 class="profile-name">@Model.ProjectName</h2>
                <p class="profile-title">@(Model.Type ?? "Webbprojekt")</p>

                <div class="profile-contact-details">
                    <p class="contact-item"><i class="fas fa-info-circle"></i> <strong>Status:</strong> @(Model.Status ?? "Aktivt")</p>
                    <p class="contact-item"><i class="fas fa-calendar-alt"></i> <strong>Start:</strong> @Model.StartDate.ToString("yyyy-MM-dd")</p>
                    <p class="contact-item"><i class="fas fa-calendar-check"></i> <strong>Slut:</strong> @(Model.EndDate.HasValue? Model.EndDate.Value.ToString("yyyy-MM-dd") : "Pågående")</p>
                </div>
            </div>

            @* 3. ÅTGÄRDSKNAPPAR *@
            <div class="sidebar-actions-container">
                <a href="javascript:history.back()" class="btn-action btn-secondary-outline">
                    <i class="fas fa-arrow-left"></i> Tillbaka
                </a>

                @if (User.Identity.IsAuthenticated)
                {
                    @if (ViewBag.IsOwner == true)
                    {
                        @* Redigera-knapp för ägare *@
                        <a asp-controller="Project" asp-action="Edit" asp-route-id="@Model.Id" class="btn-action btn-primary" style="margin-top: 10px; background-color: #002d5a; border: none;">
                            <i class="fas fa-edit"></i> Redigera projekt
                        </a>

                        @* Admin-sektion *@
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                            <p class="small text-muted mb-2 text-center">PROJEKT-ADMIN</p>
                            <form asp-action="DeleteProject" asp-controller="Project" method="post" onsubmit="return confirm('Är du helt säker?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn-action btn-danger" style="width: 100%;">
                                    <i class="fas fa-trash-alt"></i> Radera projekt
                                </button>
                            </form>
                        </div>
                    }
                    else if (ViewBag.IsParticipant == true)
                    {
                        <form asp-action="LeaveProject" asp-controller="Project" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn-action btn-danger-outline">Lämna projektet</button>
                        </form>
                    }
                    else
                    {
                        @* Knappen anropar nu funktionen som öppnar popupen *@
                        <button type="button" class="btn-action btn-primary" onclick="showJoinPopup(@Model.Id, '@Model.ProjectName')">
                            Gå med i projektet
                        </button>
                    }
                }
            </div>
        </div>
    </aside>

    @* --- HUVUDINNEHÅLL --- *@
    <section class="profile-main-content">
        @* OM PROJEKTET *@
        <div class="cv-section" id="section-Description">
            <form asp-action="UpdateDescription" asp-controller="Project" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="cv-header-row">
                    <h3 class="section-title">Om projektet</h3>
                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Description')">Redigera</button>
                        <button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
                    }
                </div>
                <div class="cv-text">
                    <div class="display-mode">
                        <p style="white-space: pre-line;">@(string.IsNullOrEmpty(Model.Description) ? "Ingen beskrivning tillgänglig." : Model.Description)</p>
                    </div>
                    <textarea name="description" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:150px;">@Model.Description</textarea>
                </div>
            </form>
        </div>

        @* DELTAGARE *@
        <div class="projects-block">
            <div class="cv-header-row">
                <h3 class="section-title">Deltagare</h3>
            </div>

            @if (Model.PersonProjects != null && Model.PersonProjects.Any())
            {
                <div class="projects-list" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px;">
                    @foreach (var pp in Model.PersonProjects)
                    {
                        @* 1. HÄR ÄR ÄNDRINGEN: Kontrollera om personen är publik ELLER om besökaren är inloggad *@
                        @if (!pp.Person.IsPrivate || User.Identity.IsAuthenticated)
                        {
                            bool isProjectOwner = pp.PersonId == Model.OwnerId;

                            <a asp-controller="Person" asp-action="Profile" asp-route-id="@pp.Person.Id" class="project-pill" style="background-color: #ebf5ff; color: #2c3e50; border: @(isProjectOwner ? "2px solid #3498db" : "1px solid #dee2e6"); text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; border-radius: 12px; width: 160px; height: 140px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                                @if (isProjectOwner)
                                {
                                    <div style="position: absolute; top: 0; right: 0; background: #3498db; color: white; font-size: 0.65rem; font-weight: bold; padding: 4px 8px; border-radius: 0 11px 0 8px;">ÄGARE</div>
                                }
                                <span style="font-weight: bold; font-size: 1.05rem; color: #212529;">@pp.Person.FirstName @pp.Person.LastName</span>
                                <span style="font-size: 0.85rem; color: @(isProjectOwner ? "#0056b3" : "#495057");">
                                    @(string.IsNullOrEmpty(pp?.Role) ? "Deltagare" : pp.Role)
                                </span>
                            </a>
                        }
                    }

                    @* 2. VALFRITT: Visa ett meddelande om användaren är utloggad och det finns dolda profiler *@
                    @if (!User.Identity.IsAuthenticated && Model.PersonProjects.Any(pp => pp.Person.IsPrivate))
                    {
                        <p class="text-muted" style="width: 100%; margin-top: 10px;">
                            <em>Vissa deltagare har privata profiler och visas endast för inloggade användare.</em>
                        </p>
                    }
                </div>
            }
            else
            {
                <p class="text-muted" style="margin-top: 15px;">Inga deltagare registrerade i detta projekt.</p>
            }
        </div>

        @* RESURSER *@
        <div class="cv-section" style="margin-top: 30px;">
            <div class="cv-header-row">
                <h3 class="section-title">Resurser</h3>
            </div>
            @if (!string.IsNullOrEmpty(Model.ZipUrl))
            {
                <div class="resource-container" style="max-width: 280px; margin-top: 15px;">
                    <div class="file-card-v2" style="padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; text-align: center; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                        <i class="fas fa-file-archive" style="font-size: 2.5rem; color: #e67e22; display: block; margin-bottom: 10px;"></i>
                        <span style="font-weight: bold; color: #2c3e50; display: block; margin-bottom: 15px;">Projektfiler (.zip)</span>
                        <a href="~/uploads/projects/@Model.ZipUrl" class="btn-action btn-primary" download="@(Model.ProjectName + "_kod.zip")" style="text-decoration: none; display: inline-block; width: 100%;">
                            <i class="fas fa-download"></i> Ladda ned
                        </a>
                    </div>
                </div>
            }
            else
            {
                <p style="color: #7f8c8d; font-style: italic; margin-top: 15px;">Det finns inga resurser uppladdade.</p>
            }
        </div>
    </section>
</div>

@* --- MODAL FÖR ATT ANGE ROLL --- *@
<div class="modal fade" id="joinRoleModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #002d5a; color: white;">
                <h5 class="modal-title">Ange din roll</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            @* Vi postar till 'JoinProject' eftersom det är den metod som skickar oss tillbaka till denna sida *@
            <form asp-action="JoinProject" asp-controller="Project" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <p id="modalProjectText" class="fw-bold"></p>
                    <input type="hidden" name="projectId" id="modalProjectId" />

                    <div class="mb-3">
                        <label class="form-label">Vad är din roll i detta projekt?</label>
                        <input type="text" name="role" class="form-control" placeholder="t.ex. Frontend-utvecklare, Tester..." required />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                    <button type="submit" class="btn btn-success">Gå med</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function showJoinPopup(projectId, projectName) {
        document.getElementById('modalProjectId').value = projectId;
        document.getElementById('modalProjectText').innerText = "Gå med i: " + projectName;

        var myModal = new bootstrap.Modal(document.getElementById('joinRoleModal'));
        myModal.show();
    }
</script>

<script>
    function enableEdit(sectionId) {
        const section = document.getElementById('section-' + sectionId);
        section.querySelector('.display-mode').style.display = 'none';
        section.querySelector('.edit-mode').style.display = 'block';
        section.querySelector('.edit-btn').style.display = 'none';
        section.querySelector('.save-btn').style.display = 'inline-block';
    }
</script>
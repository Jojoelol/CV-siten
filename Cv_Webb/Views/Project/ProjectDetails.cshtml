@model CV_siten.Data.Models.Project

@{
    ViewData["Title"] = "Projektinformation";
}

<div class="profile-page-wrapper">
    @* --- SIDEBAR: PROJEKT-INFO --- *@
    <aside class="profile-sidebar">
        <div class="sidebar-card">

            @* 1. PROJEKTBILD *@
            <div class="project-image-placeholder project-details-image-wrap">
                <img src="~/images/projects/@(string.IsNullOrEmpty(Model.ImageUrl) ? "defaultbildProjekt.jpg" : Model.ImageUrl)"
                     alt="Projektbild"
                     class="project-details-image" />
            </div>

            @* 2. INFO-TEXT *@
            <div class="profile-info-text">
                <h2 class="profile-name">@Model.ProjectName</h2>
                <p class="profile-title">@(Model.Type ?? "Webbprojekt")</p>

                <div class="profile-contact-details">
                    <p class="contact-item"><i class="fas fa-info-circle"></i> <strong>Status:</strong> @(Model.Status ?? "Aktivt")</p>
                    <p class="contact-item"><i class="fas fa-calendar-alt"></i> <strong>Start:</strong> @Model.StartDate.ToString("yyyy-MM-dd")</p>
                    <p class="contact-item"><i class="fas fa-calendar-check"></i> <strong>Slut:</strong> @(Model.EndDate.HasValue? Model.EndDate.Value.ToString("yyyy-MM-dd") : "Pågående")</p>
                </div>
            </div>

            @* 3. ÅTGÄRDSKNAPPAR *@
            <div class="sidebar-actions-container">
                <a href="#" id="smartBackBtn" class="btn-action btn-secondary-outline">
                    <i class="fas fa-arrow-left"></i> Tillbaka
                </a>

                @if (User.Identity.IsAuthenticated)
                {
                    @if (ViewBag.IsOwner == true)
                    {
                        <a asp-controller="Project"
                           asp-action="Edit"
                           asp-route-id="@Model.Id"
                           class="btn-action btn-primary project-details-edit-btn">
                            <i class="fas fa-edit"></i> Redigera projekt
                        </a>

                        <div class="project-details-admin-box">
                            <p class="small text-muted mb-2 text-center">PROJEKT-ADMIN</p>

                            <form asp-action="DeleteProject"
                                  asp-controller="Project"
                                  method="post"
                                  onsubmit="return confirm('Är du helt säker?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteProjectModal">
                                    <i class="fas fa-trash-alt"></i> Radera projekt
                                </button>
                            </form>
                        </div>
                    }
                    else if (ViewBag.IsParticipant == true)
                    {
                        <form asp-action="LeaveProject" asp-controller="Project" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn-action btn-danger-outline">Lämna projektet</button>
                        </form>
                    }
                    else
                    {
                        <button type="button"
                                class="btn-action btn-primary all-projects-join-btn"
                                data-project-id="@Model.Id"
                                data-project-name="@Model.ProjectName">
                            Gå med i projektet
                        </button>
                    }
                }
            </div>

        </div>
    </aside>

    @* --- HUVUDINNEHÅLL --- *@
    <section class="profile-main-content">

        @* OM PROJEKTET *@
        <div class="cv-section" id="section-Description">
            <form asp-action="UpdateDescription" asp-controller="Project" method="post">
                <input type="hidden" name="id" value="@Model.Id" />

                <div class="cv-header-row">
                    <h3 class="section-title">Om projektet</h3>

                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button"
                                class="btn-action btn-outline btn-edit-small edit-btn"
                                data-enable-edit="Description">
                            Redigera
                        </button>

                        <button type="submit"
                                class="btn-action btn-primary btn-edit-small save-btn u-hidden">
                            Spara
                        </button>
                    }
                </div>

                <div class="cv-text">
                    <div class="display-mode">
                        <p class="project-details-preline">
                            @(string.IsNullOrEmpty(Model.Description) ? "Ingen beskrivning tillgänglig." : Model.Description)
                        </p>
                    </div>

                    <textarea name="description"
                              class="form-control-custom edit-mode project-details-desc-textarea u-hidden">@Model.Description</textarea>
                </div>
            </form>
        </div>

        @* --- DELTAGARE --- *@
        <div class="projects-block">
            <div class="cv-header-row">
                <h3 class="section-title">Deltagare</h3>
            </div>

            @if (Model.PersonProjects != null && Model.PersonProjects.Any())
            {
                <div class="projects-list project-details-participants-list">
                    @foreach (var pp in Model.PersonProjects.OrderByDescending(p => p.PersonId == Model.OwnerId))
                    {
                        @if (!pp.Person.IsPrivate || User.Identity.IsAuthenticated)
                        {
                            bool isProjectOwner = pp.PersonId == Model.OwnerId;

                            <a asp-controller="Person"
                               asp-action="Profile"
                               asp-route-id="@pp.Person.Id"
                               class="project-pill project-details-pill @(isProjectOwner ? "is-owner" : "")">

                                @if (isProjectOwner)
                                {
                                    <div class="project-details-owner-badge">ÄGARE</div>
                                }

                                <span class="project-details-pill-name">
                                    @pp.Person.FirstName @pp.Person.LastName
                                </span>

                                <span class="project-details-pill-role">
                                    @(string.IsNullOrEmpty(pp?.Role) ? "Deltagare" : pp.Role)
                                </span>
                            </a>
                        }
                    }

                    @if (!User.Identity.IsAuthenticated && Model.PersonProjects.Any(pp => pp.Person.IsPrivate))
                    {
                        <p class="text-muted project-details-private-note">
                            <em>Vissa deltagare har privata profiler och visas endast för inloggade användare.</em>
                        </p>
                    }
                </div>
            }
            else
            {
                <p class="text-muted project-details-no-participants">Inga deltagare registrerade i detta projekt.</p>
            }
        </div>

        @* RESURSER *@
        <div class="cv-section project-details-resources">
            <div class="cv-header-row">
                <h3 class="section-title">Resurser</h3>
            </div>

            @if (!string.IsNullOrEmpty(Model.ZipUrl))
            {
                <div class="resource-container project-details-resource-wrap">
                    <div class="file-card-v2 project-details-file-card">
                        <i class="fas fa-file-archive project-details-file-icon"></i>
                        <span class="project-details-file-title">Projektfiler (.zip)</span>

                        <a href="~/uploads/projects/@Model.ZipUrl"
                           class="btn-action btn-primary project-details-download-btn"
                           download="@(Model.ProjectName + "_kod.zip")">
                            <i class="fas fa-download"></i> Ladda ned
                        </a>
                    </div>
                </div>
            }
            else
            {
                <p class="project-details-no-resources">Det finns inga resurser uppladdade.</p>
            }
        </div>

    </section>
</div>

@* Vi skickar med "JoinProject" här *@
<partial name="_JoinRoleModal" view-data='@new ViewDataDictionary(ViewData) { { "JoinAction", "Join" } }' />

@if (TempData["SuccessMessage"] != null)
{
    string msg = TempData["SuccessMessage"] as string;
    bool isJoinMessage = msg.Contains("Välkommen") || msg.Contains("gått med");

    <div id="saveSuccessPopup"
         class="success-popup-overlay"
         data-redirect-url="">
        @* Lämnar URL tom för att bara dölja popupen, inte ladda om *@

        <div class="success-popup-content animated-popup">
            <i class="fas fa-check-circle success-icon project-details-success-icon"></i>

            @if (isJoinMessage)
            {
                <h3 class="project-details-success-title">Välkommen till projektet!</h3>
            }
            else
            {
                <h3 class="project-details-success-title">Ändringar sparade!</h3>
            }

            <p class="text-muted">@msg</p>
        </div>
    </div>
}
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Bekräfta radering</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3">
                    <i class="fas fa-folder-minus fa-4x text-danger opacity-25"></i>
                </div>
                <h5>Vill du verkligen radera "@Model.ProjectName"?</h5>
                <p class="text-muted">Detta kommer att ta bort projektet permanent för alla deltagare. Denna åtgärd kan inte ångras.</p>
            </div>
            <div class="modal-footer border-0 bg-light">
                <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Avbryt</button>

                @* Här ligger det faktiska formuläret som skickar raderingen till din Controller *@
                <form asp-controller="Project" asp-action="Delete" asp-route-id="@Model.Id" method="post">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger px-4 shadow-sm">Radera permanent</button>
                </form>
            </div>
        </div>
    </div>
</div>
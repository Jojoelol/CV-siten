@model CV_siten.Data.Models.Project

<div class="profile-page-wrapper">
    @* --- SIDEBAR: PROJEKT-INFO --- *@
    <aside class="profile-sidebar">
        <div class="sidebar-card">
            <div class="project-image-placeholder" style="width: 100%; height: 180px; background-color: #3498db; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                <i class="fas fa-project-diagram" style="font-size: 3.5rem; color: white;"></i>
            </div>

            <div class="profile-info-text">
                <h2 class="profile-name">@Model.ProjectName</h2>
                <p class="profile-title">@(Model.Type ?? "Webbprojekt")</p>

                <div class="profile-contact-details">
                    <p class="contact-item">
                        <i class="fas fa-info-circle"></i> <strong>Status:</strong> @(Model.Status ?? "Aktivt")
                    </p>
                    <p class="contact-item">
                        <i class="fas fa-tag"></i> <strong>Typ:</strong> @(Model.Type ?? "Ej angiven")
                    </p>
                    <p class="contact-item">
                        <i class="fas fa-calendar-alt"></i> <strong>Start:</strong> @Model.StartDate.ToString("yyyy-MM-dd")
                    </p>
                    <p class="contact-item">
                        <i class="fas fa-calendar-check"></i> <strong>Slut:</strong> @(Model.EndDate.HasValue? Model.EndDate.Value.ToString("yyyy-MM-dd") : "Pågående")
                    </p>
                </div>
            </div>

            <div class="sidebar-actions-container">
                <a href="javascript:history.back()" class="btn-action btn-secondary-outline">
                    <i class="fas fa-arrow-left"></i> Tillbaka
                </a>

                @* LOGIK FÖR DELTAGANDE *@
                @if (User.Identity.IsAuthenticated)
                {
                    @if (ViewBag.IsParticipant == true)
                    {
                        @if (ViewBag.IsOwner == true)
                        {
                            @* ÄGARENS ADMIN-KNAPPAR *@
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
                                <p class="small text-muted mb-2 text-center">PROJEKT-ADMIN</p>
                                <form asp-action="DeleteProject" asp-controller="Project" method="post" onsubmit="return confirm('Är du helt säker? Projektet och alla dess kopplingar kommer raderas permanent.');">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <button type="submit" class="btn-action btn-danger" style="width: 100%;">
                                        <i class="fas fa-trash-alt"></i> Radera projekt
                                    </button>
                                </form>
                            </div>
                        }
                        else
                        {
                            @* VANLIG DELTAGARE KAN LÄMNA *@
                            <form asp-action="LeaveProject" asp-controller="Project" method="post" onsubmit="return confirm('Vill du lämna projektet?');">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <button type="submit" class="btn-action btn-danger-outline">
                                    Lämna projektet
                                </button>
                            </form>
                        }
                    }
                    else
                    {
                        @* INTE DELTAGARE ÄN *@
                        <form asp-action="Join" asp-controller="Project" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="projectId" value="@Model.Id" />
                            <button type="submit" class="btn-action btn-primary">
                                Gå med i projektet
                            </button>
                        </form>
                    }
                }
            </div>
        </div>
    </aside>

    @* --- HUVUDINNEHÅLL --- *@
    <section class="profile-main-content">
        @* --- OM PROJEKTET --- *@
        <div class="cv-section" id="section-Description">
            <form asp-action="UpdateDescription" asp-controller="Project" method="post">
                <input type="hidden" name="id" value="@Model.Id" />

                <div class="cv-header-row">
                    <h3 class="section-title">Om projektet</h3>
                    @if (ViewBag.IsOwner == true)
                    {
                        <button type="button" class="btn-action btn-outline btn-edit-small edit-btn" onclick="enableEdit('Description')">Redigera</button>
                        <button type="submit" class="btn-action btn-primary btn-edit-small save-btn" style="display:none;">Spara</button>
                    }
                </div>

                <div class="cv-text">
                    <div class="display-mode">
                        @if (!string.IsNullOrEmpty(Model.Description))
                        {
                            <p style="white-space: pre-line;">@Model.Description</p>
                        }
                        else
                        {
                            <p style="color: #7f8c8d; font-style: italic;">Ingen beskrivning tillgänglig.</p>
                        }
                    </div>
                    <textarea name="description" class="form-control-custom edit-mode" style="display:none; width:100%; min-height:150px;">@Model.Description</textarea>
                </div>
            </form>
        </div>

        @* --- DELTAGARE --- *@
        <div class="projects-block">
            <div class="cv-header-row">
                <h3 class="section-title">Deltagare</h3>
            </div>

            @if (Model.PersonProjects != null && Model.PersonProjects.Any())
            {
                <div class="projects-list" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 15px;">
                    @foreach (var pp in Model.PersonProjects)
                    {
                        bool isProjectOwner = pp.PersonId == Model.OwnerId;

                        <a asp-controller="Person" asp-action="Profile" asp-route-id="@pp.Person.Id"
                           class="project-pill"
                           style="background-color: #ebf5ff;
                                  color: #2c3e50; @* Mörkgrå/Svart text för hela rutan *@
                                  border: @(isProjectOwner ? "2px solid #3498db" : "1px solid #dee2e6");
                                  text-decoration: none;
                                  display: flex;
                                  flex-direction: column;
                                  align-items: center;
                                  justify-content: center;
                                  text-align: center;
                                  padding: 20px;
                                  border-radius: 12px;
                                  width: 160px;
                                  height: 140px;
                                  position: relative;
                                  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                                  transition: all 0.2s ease-in-out;">

                            @if (isProjectOwner)
                            {
                                @* "ÄGARE"-flik i hörnet *@
                                <div style="position: absolute; top: 0; right: 0; background: #3498db; color: white; font-size: 0.65rem; font-weight: bold; padding: 4px 8px; border-radius: 0 11px 0 8px; letter-spacing: 0.5px;">
                                    ÄGARE
                                </div>
                            }

                            @* Namnet - Svart text *@
                            <span style="font-weight: bold; font-size: 1.05rem; display: block; margin-bottom: 5px; color: #212529;">
                                @pp.Person.FirstName @pp.Person.LastName
                            </span>

                            @* Rollen - Mörkblå för ägare, mörkgrå för deltagare *@
                            <span style="font-size: 0.85rem; color: @(isProjectOwner ? "#0056b3" : "#495057"); font-weight: @(isProjectOwner ? "600" : "400");">
                                @(isProjectOwner ? "Projektägare" : (pp.Role ?? "Deltagare"))
                            </span>
                        </a>
                    }
                </div>
            }
        </div>

        @* --- RESURSER --- *@
        <div class="cv-section" style="margin-top: 30px;">
            <div class="cv-header-row">
                <h3 class="section-title">Resurser</h3>
            </div>
            <div class="resource-container" style="max-width: 280px; margin-top: 15px;">
                <div class="file-card-v2" style="padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; text-align: center; background: #fff;">
                    <i class="fas fa-file-archive" style="font-size: 2.5rem; color: #e67e22; display: block; margin-bottom: 10px;"></i>
                    <span style="font-weight: bold; color: #2c3e50; display: block; margin-bottom: 15px;">Projektkod.zip</span>
                    <a href="#" class="btn-action btn-primary"><i class="fas fa-download"></i> Ladda ned</a>
                </div>
            </div>
        </div>
    </section>
</div>